import win.ui;
/*DSG{{*/
var winform = win.form(text="BeHappy 智能助理";right=757;bottom=467)
winform.add()
/*}}*/

import web.view;
var wb = web.view(winform);

wb.html = /**
<!DOCTYPE html><html>
<head>
	<meta charset="utf-8" />
	<title>WebView2</title>

	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
	<script src="https://lib.baomitu.com/react/17.0.2/umd/react.development.js"></script>
	<script src="https://lib.baomitu.com/react-dom/17.0.2/umd/react-dom.development.js"></script>
	<link rel="stylesheet" href="https://lib.baomitu.com/chatui-core/2.4.2/index.min.css">
	<script src="https://lib.baomitu.com/babel-standalone/7.18.13/babel.min.js"></script>
	<script src="https://g.alicdn.com/chatui/icons/0.3.0/index.js"></script>

    <script src="https://g.alicdn.com/chatui/sdk-v2/0.2.4/sdk.js"></script>
    <script src="https://g.alicdn.com/chatui/extensions/0.0.7/isv-parser.js"></script>
	<style type="text/css">html,body,#app{height:100%}</style>
</head>
<body>
<script type="text/babel">
	const { useState,useEffect,useCallback,useRef } =  React;
	const { default: Chat, Bubble, useMessages, Image } = ChatUI
	const schema = 'http://'
	const basePath = 'localhost:4000';
	const baseUrl = schema + basePath + '/chat-gpt';
	let sessionMsg = "";
	const App = () => {
		const [msgID, setMsgID] = useState("");
  		const [result, setResult] = useState("");
  		let msg = "";
  		const { messages, appendMsg, setTyping, updateMsg } = useMessages([{
    		type: 'text',
    		content: { text: '主人好，我是 BeHappy 智能助理，你的贴心小助手~' },
    		user: { avatar: 'https://gitee.com/xiaowu_wang/pic/raw/master/1680245769332.jpg' },
  		}]);
		const toolbar = [
 			{
   				type: 'image',
   				icon: 'image',
   				title: '相册',
 			},
 			{
   				type: 'speech',
   				icon: 'mic',
   				title: '语音输入'
 			}
		];
		// 默认快捷短语，可选
		const defaultQuickReplies = [
 			{
   				icon: 'message',
   				name: '你好',
   				isNew: true,
   				isHighlight: true,
 			},
 			{
   				name: '你能做什么',
   				isNew: true,
 			}
		];
  		useEffect(() => {
			// 监听result的改变，来实现打字机效果
    		updateMsg(msgID, {
      			type: "text",
      			content: { text: result }
    		});
  		}, [result]);

		const socket = new WebSocket('ws://' + basePath);
		// 监听连接打开事件
		socket.addEventListener('open', (event) => {
  			console.log('WebSocket 连接已打开');
		});
		// 监听收到消息事件
		socket.addEventListener('message', (event) => {
  			console.log('收到服务器消息:', event.data);
      		// 处理sessionMsg，保证上下文
        	if(event.data === '[DONE]'){
        		// 说明是结尾
        		sessionMsg += '\n';
        	}else {
        	    msg += event.data;
        		setResult(msg);
        		sessionMsg += event.data;
        	}
		});
		// 监听连接关闭事件
		socket.addEventListener('close', (event) => {
  			console.log('WebSocket 连接已关闭');
		});
		// 获取当前时间戳
  		function nanoid() {
  			return new Date().getTime().toString();
  		}
 		// 快捷短语回调，可根据 item 数据做出不同的操作，这里以发送文本消息为例
 		function handleQuickReplyClick(item) {
   			handleSend('text', item.name);
 		}

 		function toolbarClick (item, ctx) {
 			if(item.type === 'image'){
 				// todo 图片解析
      			appendMsg({
        			type: 'text',
        			content: { text: '抱歉，该功能暂未实现' }
      			});
 			}
 			// 录音
   			if (item.type === 'speech') {
   				// 这里改成 App 提供的 bridge 方法
        		nativeInvoke('speech', (text) => {
                    if (text) {
                        // 通过 setText 更新输入框内容
                        bot.appRef.current.setText(text);
                    }
        		});
   			}
 		}
  		function handleSend(type, val) {
      		// 先设置一个唯一的msgID
      		const msgID = nanoid();
      		setMsgID(msgID);
      		// 重置msg
      		msg = "";
      		// 重置对话框
      		setResult(msg);
    		if (type === 'text' && val.trim()) {
      			appendMsg({
        			type: 'text',
        			content: { text: val },
        			position: 'right',
      			});

      			setTyping(true);
      			// 判断是否以图片二字开头，然后以:进行分割取后半部分
    			if (val.startsWith("图片")) {
    			    val = val.substr(3)
    			    // 定义url
					const url = baseUrl + '/images/generations'
					$.ajax({
  						url: url,
  						type: 'POST',
  						data: {
  							"prompt": val
						},
  						success: function(response) {
    						console.log("请求成功，返回数据为：" + response);
    						appendMsg({
          						type: 'image',
          						content: { picUrl: response.data },
        					})
  						},
  						error: function(xhr, status, error) {
    						console.log("请求失败，错误信息为：" + error);
  						}
					});
    			}else {
      				// 处理sessionMsg，保证上下文;
        			sessionMsg += "你: " + val + "\nAI:";
    				appendMsg({
        				_id: msgID,
          				type: 'text',
          				content: { text: result },
        			})
        			socket.send(sessionMsg);
    			}

    		}
  		}
  		// 修改inputType
  		function inputTypeChange(inputType) {
  			if(inputType === 'voice'){
  				return 'text';
  			}
  			return 'voice';
  		}
  		function renderMessageContent(msg) {
    		const { type, content } = msg;

    		// 根据消息类型来渲染
    		switch (type) {
      		case 'text':
        		return <Bubble content={content.text} />;
      		case 'image':
        		return (
          		<Bubble type="image">
            		<img src={content.picUrl} alt="" />
          		</Bubble>
        		);
      		default:
        		return null;
    		}
  		}

  		return (
    		<Chat
      		navbar={{ title: 'BeHappy 智能助理' }}
      		messages={messages}
      		renderMessageContent={renderMessageContent}
         	quickReplies={defaultQuickReplies}
         	onQuickReplyClick={handleQuickReplyClick}
      		onSend={handleSend}
         	placeholder={'请输入...'}
         	toolbar={toolbar}
         	onInputTypeChange={inputTypeChange}
         	recorder={{
         	    canRecord: true,
         	    onStart() {
        			console.log('开始录音');
      			},
      			onEnd() {
        			console.log('停止录音');
        			// 识别到文本后要 ctx.postMessage
      			},
      			onCancel() {
        			console.log('取消录音');
      			}
      		}}
         	onToolbarClick={toolbarClick}
    		/>
  		);
	};

	ReactDOM.render(<App />, document.querySelector('#app'));
</script>
<div id="app"></div>
**/

winform.show();
win.loopMessage();
