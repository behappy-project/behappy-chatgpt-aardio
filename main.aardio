import win.ui;
/*DSG{{*/
var winform = win.form(text="ChatGPT 桌面助理";right=757;bottom=467)
winform.add()
/*}}*/

import web.view;
var wb = web.view(winform);

wb.html = /**
<!DOCTYPE html><html>
<head>
	<meta charset="utf-8" />
	<title>WebView2</title> 
	<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
	<script src="https://lib.baomitu.com/react/17.0.2/umd/react.development.js"></script>
	<script src="https://lib.baomitu.com/react-dom/17.0.2/umd/react-dom.development.js"></script>
	<script src="https://lib.baomitu.com/chatui-core/2.4.2/index.min.js"></script> 
	<link rel="stylesheet" href="https://lib.baomitu.com/chatui-core/2.4.2/index.min.css"> 
	<script src="https://lib.baomitu.com/babel-standalone/7.18.13/babel.min.js"></script>
	<style type="text/css">html,body,#app{height:100%}</style>
</head>
<body>  

<script type="text/babel"> 
	const { useState,useEffect,useCallback,useRef } =  React;  
	const { default: Chat, Bubble, useMessages, Image } = ChatUI
	const baseUrl = 'http://localhost:4000/chat-gpt';
	const source = new EventSource(baseUrl + '/completions');
	
	
	
	const App = () => {
  		const { messages, appendMsg, setTyping } = useMessages([{
    		type: 'text',
    		content: { text: '主人好，我是 ChatGPT 智能助理，你的贴心小助手~' },
    		user: { avatar: 'https://gitee.com/xiaowu_wang/pic/raw/master/1680245769332.jpg' },
  		}]);
		
		source.onmessage = function(event) {
  			// 处理服务器推送的数据
        	appendMsg({
          		type: 'text',
          		content: { text: event.data },
        	});
		};
  		function handleSend(type, val) {
    		if (type === 'text' && val.trim()) {
      			appendMsg({
        			type: 'text',
        			content: { text: val },
        			position: 'right',
      			});
			
      			setTyping(true);
      			// 判断是否以图片二字开头，然后以:进行分割取后半部分
    			if (val.startsWith("图片")) {
    			    val = val.substr(3)
    			    // 定义url
					let url = baseUrl + '/imagesGenerations'  
					// 定义data数据
					let data = {
  						"prompt": val
					}
					// post请求
					$.post(url, data, function (ret) {
                    	appendMsg({
          					type: 'image',
          					content: { picUrl: ret.data },
        				});
					})
    			}else {
    			    // 定义url
					let url = baseUrl + '/completions';
					$.ajax({
  						url: url,
  						method: "GET",
  						data: {
  							"content": val
						},
  						success: function(response) {
    						console.log("请求成功，返回数据为：" + response);
  						},
  						error: function(xhr, status, error) {
    						console.log("请求失败，错误信息为：" + error);
  						}
					});
    			}
    			
    		}
  		}
		
  		function renderMessageContent(msg) {
    		const { type, content } = msg;
		
    		// 根据消息类型来渲染
    		switch (type) {
      		case 'text':
        		return <Bubble content={content.text} />;
      		case 'image':
        		return (
          		<Bubble type="image">
            		<img src={content.picUrl} alt="" />
          		</Bubble>
        		);
      		default:
        		return null;
    		}
  		}
		
  		return (
    		<Chat
      		navbar={{ title: '' }}
      		messages={messages}
      		renderMessageContent={renderMessageContent}
      		onSend={handleSend}
    		/>
  		);
	};
		
	ReactDOM.render(<App />, document.querySelector('#app')); 
</script>
<div id="app"></div>
**/

winform.show();
win.loopMessage();